# NAT 网关

![image-20211110220936107](/home/gaoxiang/.config/Typora/typora-user-images/image-20211110220936107.png)

按照转发网关的思路会遇到一个问题，局域网之间没有商量过，各自定义网段，因而IP段会产生冲突。

例如途中所示：服务器A的IP地址和服务器B的IP地址相同

## 公网IP

可以理解全世界的公网是一个大的局域网，每个NAT网关都有独立的IP地址

内部局域网对外的表现形式都是公网IP，不同内部局域网之间的沟通也通过公网IP实现



## NAT网关IP映射

NAT网关采取一对多的映射关系让一个本地局域网的多个终端共享一个公网IP

NAT网关如何区分内部局域网的不同终端：通过端口号区分不同终端



## 通过NAT网关通信方式

1. 目标服务器B需要一个公网身份，即它映射到的公网IP：192.168.56.2
2. 在NAT网关B上记录下来公网身份192.168.56.2对应的内网身份192.168.1.101，凡是要访问192.168.56.2，都转换成192.168.1.101
3. 所以源服务器A要访问目标服务器B，要指定的目标地址为192.168.56.2，即B对应的公网IP
4. 服务器A发送ARP获取网关192.168.1.1的MAC地址并向其发包，发包内容：
   - 源MAC：服务器A的MAC
   - 目标MAC：192.168.1.1这个网口的MAC地址
   - 源IP：192.168.1.101
   - 目标IP：192.168.56.2
5. 包到达192.168.1.1这个网口，发现MAC一致，将包接收，然后开始寻找往哪里转发
6. 路由器A配置了静态路由：要想访问192.168.56.2/24，要从192.168.56.1这个口出去，没有下一跳了，紧接着的网卡就是这个网段的
7. 路由器A匹配上这条路由，从192.168.56.1这个口将数据包发给192.168.56.2
8. 路由器A发送ARP获取192.168.56.2网关的MAC地址
9. 当网络包发到公网是，服务器A也需要有公共身份，因此在公网中源IP地址不能用192.168.1.101，需要改成192.168.56.1，发包内容会变成：
   - 源MAC：192.168.56.1的MAC地址
   - 目标MAC：192.168.56.2的MAC地址
   - 源IP：192.168.56.1 （源IP在公网中转化成对应的公网IP）
   - 目标IP：192.168.56.2

10. 包到达192.168.56.2这个网口，发现MAC一致，将包接收，并判断往哪里转发

11. 路由器B是一个NAT网关，它上面配置了要访问公网IP：192.168.56.2对应的内部局域网IP：192.168.1.101，于是目标IP变为192.168.1.101

12. 在路由器B中配置了静态路由：要访问192.168.1.0/24，要从192.168.1.1这个口出去

13. 因为目标地址192.168.1.101/24就在相同网段，无需下一跳，直接到达

14. 路由器B发起ARP，获取192.168.1.101的MAC地址，向其发送数据包，包的内容会变为：

    - 源MAC：192.168.1.1的MAC地址
    - 目标MAC：192.168.1.101的MAC地址
    - 源IP：192.168.56.1
    - 目标IP：192.168.1.101

    