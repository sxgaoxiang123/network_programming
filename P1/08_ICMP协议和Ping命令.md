# ICMP 协议

ping命令是基于ICMP协议工作的，ICMP全称为Internet Control Message Protocol，互联网控制报文协议

网络包在复杂的网络环境中传输时，会遇到各种问题，当遇到问题传输不畅时要反馈消息出来，这样才能调整传输策略。

## IP 数据报

![image-20211109221226064](../image/image-20211109221226064.png)

- IP数据报的首部长度和数据长度都是可变长的，单总是4字节的整数倍，对于IPv4来说4位版本字段是4
- 4位首不长度的数值是以4字节为单位的，最小值为5个单位长度，即20个字节，也就是不带任何选项的IP首部，4位能彪是的最大值是15，即首部最长为60字节
- 8位TOS字段有3个位用来指定IP数据报的优先级（目前已弃用）还有4位表示可选的服务类型（最小延迟、最大吞吐量、最大可靠性、最小成本），还有一个位总是0，
- 总长度是整个数据报（包括IP首部和IP层payload）的字节数
- 每传一个IP数据报，16位的表示加1，可用于分片和充足数据报

- 3位标志和13位片偏移用于分片
- **TTL（Time to live）**：源主机为数据包设定一个生存时间，比如64，每过一个路由器该值就减1，如果减到0说明路由已经太长了仍然找不到目标主机的网络，就丢包，因此该生存时间不是秒，而是跳（hop）
- 8位协议字段指示上层协议是TCP、UDP、ICMP还是IGMP
- 16位校验和：只校验IP首部，数据的校验由更高层协议负责
- IPv4的IP地址长度为32
- 选项字段的解释从略



## ICMP 报文封装

![image-20211109224205444](../image/image-20211109224205444.png)

ICMP报文基于IP数据报进行封装拓展

- Type

  - 常用类型主动请求为8
  - 常用类型主动请求的应答为0

- Code

- 常用Type和Code对应关系

  ![image-20211109224423603](../image/image-20211109224423603.png)

- 校验和：对类型、代码进行校验



## ICMP与Ping

- 常用的ping就是查询报文，是一种主动请求，并且获得主动应答的ICMP协议，所以ping发的包也是符合ICMP协议格式的，只不过它在后面增加了自己的格式

- 对ping的主动请求，进行网络抓包，称为ICMP ECHO REQUEST，同里主动请求的回复称为ICMP ECHO REPLY

- 比起原本的ICMP，ping命令会多处两个字段
  - 标识符：用于指明数据包的身份
  - 序号：用于区分相同身份的不同会话，即编号

- 差错报文：差错报文的结构相对复杂一些，除了前面的IP、ICMP的前8字节不变，后面跟上出错的那个IP包的IP首部，和IP正文的前8字节
  - 终点不可达
  - 源站抑制
  - 时间超时
  - 路由重定向



# Ping

## ping的收发过程

![image-20211109230529259](../image/image-20211109230529259.png)

即由源头的上层逐渐向底层打包报文，然后再到目的地由底层向上层逐步拆包，实现端到端的信息传递



